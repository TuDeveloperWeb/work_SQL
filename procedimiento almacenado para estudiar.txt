Text
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE PROC uSP_RM_FACTURACION_CUENTA_CORRIENTE_CLIENTE
  @RUC VARCHAR(15),
  @HISTORICO BIT
AS
  SELECT RTRIM(A.CUSTNMBR) CUSTNMBR_PRINC,RTRIM(A.DOCNUMBR) DOCNUMBR_PRINC,A.RMDTYPAL RMDTYPAL_PRINC,RTRIM(A.CURNCYID) CURNCYID_PRINC
		,RTRIM(B.CUSTCLAS) CUSTCLAS,RTRIM(A.CUSTNMBR) CUSTNMBR,RTRIM(B.CUSTNAME) CUSTNAME,RTRIM(A.DOCNUMBR) DOCNUMBR,A.DOCDATE
		,ISNULL(C.ORORGTRX,A.ORTRXAMT) MONTO_COMPROBANTE,A.ORTRXAMT,C.ORORGTRX,RTRIM(A.CURNCYID) CURNCYID,A.DUEDATE
	INTO #DOCUMENTOS
    FROM RM20101_RM30101 A
		 INNER JOIN RM00101 B ON A.CUSTNMBR=B.CUSTNMBR
		 LEFT JOIN MC020102 C ON C.DOCNUMBR=A.DOCNUMBR AND C.RMDTYPAL=A.RMDTYPAL
   WHERE A.CUSTNMBR=(CASE @RUC WHEN '' THEN A.CUSTNMBR ELSE @RUC END)
		 AND A.VOIDSTTS=0 AND A.ORTRXAMT>0 AND A.RMDTYPAL IN (1,2,3,4,5)
  UNION ALL
  SELECT RTRIM(A.CUSTNMBR) CUSTNMBR_PRINC,RTRIM(A.DOCNUMBR) DOCNUMBR_PRINC,A.RMDTYPAL RMDTYPAL_PRINC,RTRIM(A.CURNCYID) CURNCYID_PRINC
		,RTRIM(B.CUSTCLAS) CUSTCLAS,RTRIM(A.CUSTNMBR) CUSTNMBR,RTRIM(B.CUSTNAME) CUSTNAME,RTRIM(A.DOCNUMBR) DOCNUMBR,A.DOCDATE
		,-ISNULL(C.ORORGTRX,A.ORTRXAMT) MONTO_COMPROBANTE,-A.ORTRXAMT,-C.ORORGTRX,RTRIM(A.CURNCYID) CURNCYID,A.DUEDATE
    FROM RM20101_RM30101 A
		 INNER JOIN RM00101 B ON A.CUSTNMBR=B.CUSTNMBR
		 LEFT JOIN MC020102 C ON C.DOCNUMBR=A.DOCNUMBR AND C.RMDTYPAL=A.RMDTYPAL
   WHERE A.CUSTNMBR=(CASE @RUC WHEN '' THEN A.CUSTNMBR ELSE @RUC END)
		 AND A.VOIDSTTS=0 AND A.ORTRXAMT>0 AND A.RMDTYPAL IN (6,7,8,9)

  SELECT RTRIM(A.CUSTNMBR) CUSTNMBR_PRINC,RTRIM(APTODCNM) DOCNUMBR_PRINC,APTODCTY RMDTYPAL_PRINC,RTRIM(A.CURNCYID) CURNCYID_PRINC
		,RTRIM(B.CUSTCLAS) CUSTCLAS,RTRIM(A.CUSTNMBR) CUSTNMBR,RTRIM(B.CUSTNAME) CUSTNAME,RTRIM(APFRDCNM) APFRDCNM,APFRDCDT DOCDATE
		,ORAPTOAM MONTO_COMPROBANTE,APPTOAMT,ORAPTOAM,RTRIM(FROMCURR) CURNCYID,NULL DUEDATE
    INTO #APLICACIONES
    FROM RM20201_RM30201 A
		 INNER JOIN RM00101 B ON A.CUSTNMBR=B.CUSTNMBR 
   WHERE A.CUSTNMBR=(CASE @RUC WHEN '' THEN A.CUSTNMBR ELSE @RUC END)
		AND EXISTS(SELECT 1 FROM #DOCUMENTOS C WHERE A.APTODCNM=C.DOCNUMBR)
  UNION ALL
  SELECT RTRIM(A.CUSTNMBR) CUSTNMBR_PRINC,RTRIM(APFRDCNM) DOCNUMBR_PRINC,APFRDCTY RMDTYPAL_PRINC,RTRIM(A.FROMCURR) CURNCYID_PRINC
		,RTRIM(B.CUSTCLAS) CUSTCLAS,RTRIM(A.CUSTNMBR) CUSTNMBR,RTRIM(B.CUSTNAME) CUSTNAME,RTRIM(APTODCNM) APFRDCNM,APTODCDT DOCDATE
		,-ActualApplyToAmount MONTO_COMPROBANTE,-APFRMAPLYAMT,-ActualApplyToAmount,RTRIM(A.CURNCYID) CURNCYID,NULL DUEDATE
    FROM RM20201_RM30201 A
		 INNER JOIN RM00101 B ON A.CUSTNMBR=B.CUSTNMBR 
   WHERE A.CUSTNMBR=(CASE @RUC WHEN '' THEN A.CUSTNMBR ELSE @RUC END)
		AND EXISTS(SELECT 1 FROM #DOCUMENTOS C WHERE A.APFRDCNM=C.DOCNUMBR)

  SELECT ROW_NUMBER()OVER(ORDER BY CUSTNMBR_PRINC,DOCNUMBR_PRINC,RMDTYPAL_PRINC,RMDTYPAL,DOCDATE) RowId,CUSTNMBR_PRINC,DOCNUMBR_PRINC
		,RMDTYPAL_PRINC,RMDTYPAL,CURNCYID_PRINC,CUSTCLAS,CUSTNMBR,CUSTNAME,DOCNUMBR,DOCDATE,MONTO_COMPROBANTE,SOLES,DOLARES,CURNCYID,DUEDATE
		,SOLES SALDO_SOLES,DOLARES SALDO_DOLARES
	INTO #REPORTE
    FROM(
  SELECT CUSTNMBR_PRINC,DOCNUMBR_PRINC,RMDTYPAL_PRINC,1 RMDTYPAL,CURNCYID_PRINC,CUSTCLAS,CUSTNMBR,CUSTNAME,DOCNUMBR,DOCDATE,MONTO_COMPROBANTE
		,CASE CURNCYID_PRINC WHEN 'PEN' THEN ORTRXAMT ELSE 0 END SOLES
		,CASE CURNCYID_PRINC WHEN 'PEN' THEN 0 ELSE ORORGTRX END DOLARES,CURNCYID,DUEDATE 
    FROM #DOCUMENTOS
  UNION ALL
  SELECT CUSTNMBR_PRINC,DOCNUMBR_PRINC,RMDTYPAL_PRINC,2 RMDTYPAL,CURNCYID_PRINC,CUSTCLAS,CUSTNMBR,CUSTNAME,APFRDCNM,DOCDATE,-MONTO_COMPROBANTE
		,CASE CURNCYID_PRINC WHEN 'PEN' THEN -APPTOAMT ELSE 0 END SOLES
		,CASE CURNCYID_PRINC WHEN 'PEN' THEN 0 ELSE -ORAPTOAM END DOLARES,CURNCYID,DUEDATE 
	FROM #APLICACIONES
		)A
 
  UPDATE #REPORTE
	SET SALDO_DOLARES=ISNULL((select sum(SALDO_DOLARES) from #REPORTE where CUSTNMBR_PRINC=a.CUSTNMBR_PRINC and DOCNUMBR_PRINC=a.DOCNUMBR_PRINC AND CURNCYID_PRINC=a.CURNCYID_PRINC AND a.CURNCYID_PRINC!='PEN' and RowId<=a.RowId),0),
	    SALDO_SOLES=ISNULL((select sum(SALDO_SOLES) from #REPORTE where CUSTNMBR_PRINC=a.CUSTNMBR_PRINC and DOCNUMBR_PRINC=a.DOCNUMBR_PRINC AND CURNCYID_PRINC=a.CURNCYID_PRINC AND a.CURNCYID_PRINC='PEN' and RowId<=a.RowId),0)
   FROM #REPORTE a
  WHERE a.RowId>1

  IF(@HISTORICO=0)
  BEGIN
    SELECT CUSTNMBR_PRINC,DOCNUMBR_PRINC,CURNCYID_PRINC,SUM(MONTO_COMPROBANTE) MONTO_COMPROBANTE
	  INTO #T_DELETE
	  FROM #REPORTE
    GROUP BY CUSTNMBR_PRINC,DOCNUMBR_PRINC,CURNCYID_PRINC
    HAVING SUM(MONTO_COMPROBANTE)=0
   
	DELETE FROM #REPORTE
	 WHERE EXISTS(SELECT * FROM #T_DELETE
			WHERE #REPORTE.CUSTNMBR_PRINC=#T_DELETE.CUSTNMBR_PRINC AND #REPORTE.DOCNUMBR_PRINC=#T_DELETE.DOCNUMBR_PRINC 
					AND #REPORTE.CURNCYID_PRINC=#T_DELETE.CURNCYID_PRINC)

	DROP TABLE #T_DELETE

  END

  SELECT CUSTNMBR_PRINC,DOCNUMBR_PRINC,RMDTYPAL_PRINC,CURNCYID_PRINC,CUSTCLAS,CUSTNMBR,CUSTNAME
		,SUM(MONTO_COMPROBANTE) MONTO_COMPROBANTE,SUM(SOLES) SOLES,SUM(DOLARES) DOLARES
	INTO #SALDO_PAGOS
	FROM #REPORTE
   WHERE RMDTYPAL_PRINC IN (6,7,8,9)
  GROUP BY CUSTNMBR_PRINC,DOCNUMBR_PRINC,RMDTYPAL_PRINC,CURNCYID_PRINC,CUSTCLAS,CUSTNMBR,CUSTNAME

  DELETE FROM #REPORTE WHERE RMDTYPAL_PRINC>=6 AND DOCNUMBR_PRINC!=DOCNUMBR


  UPDATE A SET A.MONTO_COMPROBANTE=B.MONTO_COMPROBANTE,A.SOLES=B.SOLES,A.DOLARES=B.DOLARES,A.SALDO_SOLES=B.SOLES,A.SALDO_DOLARES=B.DOLARES
    FROM #REPORTE A
		 INNER JOIN #SALDO_PAGOS B ON A.RMDTYPAL_PRINC=B.RMDTYPAL_PRINC AND A.DOCNUMBR_PRINC=B.DOCNUMBR_PRINC
  
  DELETE FROM #REPORTE WHERE MONTO_COMPROBANTE=0

  SELECT RowId,CUSTNMBR_PRINC,DOCNUMBR_PRINC,RMDTYPAL_PRINC,RMDTYPAL,CURNCYID_PRINC,CUSTCLAS,CUSTNMBR,CUSTNAME,DOCNUMBR,DOCDATE
		,MONTO_COMPROBANTE,SOLES,DOLARES,CURNCYID,DUEDATE,DATEDIFF(D,DUEDATE,GETDATE()) DIASVENCIDO,SALDO_SOLES,SALDO_DOLARES
	FROM #REPORTE
   --WHERE RMDTYPAL_PRINC IN (1,2,3,4,5)
  --ORDER BY DOCNUMBR_PRINC,RMDTYPAL_PRINC

  

  DROP TABLE #DOCUMENTOS
  DROP TABLE #APLICACIONES
  DROP TABLE #SALDO_PAGOS
  DROP TABLE #REPORTE



